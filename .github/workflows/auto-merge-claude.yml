# SINGLE WORKFLOW for merge + all deploys
#
# Why one file instead of separate workflows per deploy type:
#   - The merge into main MUST happen first and only once. Separate workflows
#     would each need the merge step, creating a race condition (two workflows
#     trying to merge the same branch simultaneously).
#   - Splitting would require a shared merge workflow + workflow_run triggers,
#     adding complexity for no benefit.
#   - Each deploy step is already independent and conditional (only runs when
#     its files changed), so it behaves like separate deploys within one pipeline.
#   - Adding a new GAS project = adding one more conditional step. Simple.
#
# Flow:
#   1. Push to claude/* branch triggers this workflow
#   2. Merge into main (once)
#   3. Check what changed (git diff)
#   4. Deploy GAS projects — only if their Code.gs was modified
#   5. Delete the claude branch
#   6. Deploy GitHub Pages — only if httpsdocs/ files were modified
#   7. Direct pushes to main skip merge and just deploy
#
# HOW TO ADD A NEW GAS PROJECT:
#
#   Prerequisites — collect these from the new Apps Script project:
#     - DEPLOYMENT_ID    : Web app deployment ID (from Deploy → Manage deployments)
#                          This is also the long string in the /exec URL
#     - SPREADSHEET_ID   : Google Sheets ID (from the sheet URL between /d/ and /edit)
#     - SHEET_NAME       : Name of the sheet tab to read/write (e.g. "Live_Sheet")
#     - GITHUB_TOKEN     : Set in Apps Script: Project Settings → Script Properties
#                          Key: GITHUB_TOKEN  Value: github_pat_... token
#     - SOUND_FILE_ID    : Google Drive file ID for the GAS "Test Sound" button (optional)
#     - EMBED_PAGE_URL   : The GitHub Pages URL where this GAS app is iframed (optional)
#     - SPLASH_LOGO_URL  : Logo shown on the blue "Code Ready" splash screen (optional)
#
#   Steps:
#     1. Create a folder in googleAppsScripts/ (e.g. "My New Project")
#     2. Copy Code.gs from an existing project as a template
#     3. Update the PROJECT CONFIG section at the top of Code.gs:
#          var VERSION        = "01.00g";
#          var TITLE          = "My New Project";
#          var SPREADSHEET_ID = "your-spreadsheet-id";
#          var SHEET_NAME     = "Live_Sheet";
#          var GITHUB_OWNER   = "PFCAssociates";
#          var GITHUB_REPO    = "PFC_Website";
#          var GITHUB_BRANCH  = "main";
#          var FILE_PATH      = "googleAppsScripts/My New Project/Code.gs";
#          var DEPLOYMENT_ID  = "your-deployment-id";
#          var SOUND_FILE_ID  = "your-drive-file-id";
#          var EMBED_PAGE_URL = "https://pfcassociates.github.io/PFC_Website/your-page.html";
#          var SPLASH_LOGO_URL = "https://your-logo-url";
#     4. Bootstrap: manually copy-paste Code.gs into the Apps Script editor and save
#        (first deploy must be manual — doPost can't deploy itself before it exists)
#     5. Add a new step in this workflow BEFORE "Delete branch", using this template:
#
#        - name: Deploy My New Project
#          run: |
#            git diff --name-only HEAD~1 HEAD | grep -q "googleAppsScripts/My New Project/Code.gs" && \
#            curl -L -X POST \
#              "https://script.google.com/macros/s/DEPLOYMENT_ID_HERE/exec" \
#              -d "action=deploy" \
#              --max-time 120 || true
#
#     6. Replace DEPLOYMENT_ID_HERE with the project's deployment ID
#     7. That's it — the step only runs when that project's Code.gs changes
name: Auto-merge Claude branches

on:
  push:
    branches:
      - 'claude/**'
      - 'main'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  auto-merge:
    if: github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest
    outputs:
      pages-changed: ${{ steps.check-changes.outputs.pages-changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge into main
        id: merge
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout main
          echo "pre_merge_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          git merge --ff-only ${{ github.ref_name }} || git merge --no-edit ${{ github.ref_name }}
          git push origin main

      - name: Check what changed
        id: check-changes
        run: |
          PRE=${{ steps.merge.outputs.pre_merge_sha }}
          if git diff --name-only "$PRE" HEAD | grep -q "^httpsdocs/"; then
            echo "pages-changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "pages-changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy Gas Self-Update Dashboard
        run: |
          PRE=${{ steps.merge.outputs.pre_merge_sha }}
          # Only deploy if Code.gs was modified in this merge
          git diff --name-only "$PRE" HEAD | grep -q "googleAppsScripts/Gas Self-Update Dashboard/Code.gs" && \
          curl -L -X POST \
            "https://script.google.com/macros/s/AKfycbxL_CaBgztJ_RtpzB4mym8s5Kl0Uqu1WLNNPbbYsB7_ckvUnGAvTLbA02r_MlmP0TAg/exec" \
            -d "action=deploy" \
            --max-time 120 || true

      - name: Deploy AED Monthly Inspection Log
        run: |
          PRE=${{ steps.merge.outputs.pre_merge_sha }}
          # Only deploy if AED_Log_Code.gs was modified in this merge
          git diff --name-only "$PRE" HEAD | grep -q "googleAppsScripts/AED Monthly Inspection Log/AED_Log_Code.gs" && \
          curl -L -X POST \
            "https://script.google.com/macros/s/AKfycbyvnX5EmqA1jlbMiHD8VsLBdY8Xf00xlHF8mHsP02luflJFfhZVJl8ApxJA7I5e1udu/exec" \
            -d "action=deploy" \
            --max-time 120 || true

      - name: Deploy AED Touch UI Test
        run: |
          PRE=${{ steps.merge.outputs.pre_merge_sha }}
          # Only deploy if AED_Test_Code.gs was modified in this merge
          git diff --name-only "$PRE" HEAD | grep -q "googleAppsScripts/AED Monthly Inspection Log/AED_Test_Code.gs" && \
          curl -L -X POST \
            "https://script.google.com/macros/s/AKfycbwaSHfUXawOQnQFFIfyL0imXFwvP09aSchvIYg4FQaQLw7KIA-s_LXa0YTdkbPyrwhk/exec" \
            -d "action=deploy" \
            --max-time 120 || true

      - name: Delete branch
        run: |
          git push origin --delete ${{ github.ref_name }}

  deploy:
    if: >-
      always() &&
      (needs.auto-merge.result == 'skipped' ||
       (needs.auto-merge.result == 'success' && needs.auto-merge.outputs.pages-changed == 'true'))
    needs: auto-merge
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
      - name: Setup Pages
        uses: actions/configure-pages@v5
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './httpsdocs'
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
